# 🗄️ 資料庫管理指南

## 📋 可用指令

### **1. 查看資料庫資訊**
```bash
cd backend
npm run db:info
```

**功能：**
- 顯示資料庫檔案位置和大小
- 顯示使用者和地點的總數
- 顯示最近的使用者資訊
- 列出所有資料表

**使用時機：**
- 查看當前資料庫狀態
- 確認資料是否已清除
- 檢查資料庫是否正常

---

### **2. 清除所有資料**
```bash
cd backend
npm run db:clear
```

**功能：**
- 刪除所有使用者資料
- 刪除所有地點資料
- 重置自動遞增計數器
- **保留資料庫結構**

**使用時機：**
- 測試完成後清除測試資料
- 想要清空資料但保留表結構
- 重新開始測試

**特點：**
- ✅ 快速清除
- ✅ 保留表結構
- ✅ 不需要重新建立資料庫

---

### **3. 重建資料庫**
```bash
cd backend
npm run db:rebuild
```

**功能：**
- 刪除整個資料庫檔案
- 根據最新的結構重新建立
- 建立所有資料表
- 建立索引

**使用時機：**
- 更改資料庫結構後
- 資料庫損壞時
- 需要完全重置資料庫

**注意：**
- ⚠️ 會永久刪除所有資料
- ⚠️ 無法復原
- ⚠️ 確保已備份重要資料

---

## 🔄 常見使用情境

### **情境 1：測試後清除資料**
```bash
# 查看當前資料
npm run db:info

# 清除所有資料
npm run db:clear

# 確認資料已清除
npm run db:info
```

### **情境 2：修改資料庫結構**
```bash
# 1. 修改 init-database.ts 或模型檔案
# 2. 重建資料庫
npm run db:rebuild

# 3. 確認結構正確
npm run db:info

# 4. 啟動服務測試
npm run dev
```

### **情境 3：資料庫損壞修復**
```bash
# 重建資料庫
npm run db:rebuild

# 初始化（如果需要）
npm run init-db

# 確認正常
npm run db:info
```

---

## 📊 詳細說明

### **db:info - 資料庫資訊**

**輸出範例：**
```
📊 資料庫資訊

==================================================
📁 檔案位置: /path/to/database.sqlite
💾 檔案大小: 24.00 KB
==================================================

👤 使用者資料:
   總數: 3 筆

📍 地點資料:
   總數: 5 筆

👥 最近的使用者:
   使用者名稱: testuser
   地點數量: 2 個

📋 資料表:
   - users
   - locations

==================================================
```

---

### **db:clear - 清除資料**

**執行過程：**
```
🔗 已連接到資料庫

🗑️  開始清除所有資料...

✅ 已清除 5 筆地點資料
✅ 已清除 3 筆使用者資料
✅ 已重置自動遞增計數器

✨ 資料清除完成！
📊 資料庫結構保持不變，所有資料已清空
```

**清除的內容：**
- ✅ 所有使用者帳號
- ✅ 所有地點資料
- ✅ 自動遞增 ID（下次新增從 1 開始）

**保留的內容：**
- ✅ 資料表結構
- ✅ 索引
- ✅ 外鍵約束

---

### **db:rebuild - 重建資料庫**

**執行過程：**
```
🔄 開始重建資料庫...

✅ 已刪除舊的資料庫檔案
✅ 已建立新的資料庫檔案

📋 開始建立資料表...

✅ users 表建立成功
✅ locations 表建立成功
✅ 索引建立成功

✨ 資料庫重建完成！
📊 資料庫結構已更新，可以開始使用
```

**重建的內容：**
- ✅ 刪除舊資料庫檔案
- ✅ 建立新資料庫
- ✅ 建立 users 表
- ✅ 建立 locations 表
- ✅ 建立索引
- ✅ 設定外鍵約束

---

## 🎯 最佳實踐

### **開發流程建議：**

1. **每日開發開始：**
   ```bash
   npm run db:info  # 查看昨天的資料
   ```

2. **測試新功能：**
   ```bash
   npm run db:clear  # 清除舊測試資料
   # 進行測試
   ```

3. **修改資料庫結構：**
   ```bash
   npm run db:rebuild  # 重建資料庫
   npm run init-db     # 初始化（如果需要）
   ```

4. **每日結束：**
   ```bash
   npm run db:info  # 確認資料狀態
   ```

---

## ⚠️ 注意事項

### **重要提醒：**

1. **備份資料**
   - ⚠️ `db:clear` 和 `db:rebuild` 會永久刪除資料
   - 💡 重要資料請先備份

2. **生產環境**
   - ⛔ 這些指令僅供開發使用
   - ⛔ 不要在生產環境執行

3. **資料庫檔案**
   - 📁 位置: `backend/database.sqlite`
   - 💾 可以手動複製備份
   - 🔒 已在 `.gitignore` 中

4. **結構變更**
   - 修改結構後必須執行 `db:rebuild`
   - 確保更新 `init-database.ts`
   - 測試確認結構正確

---

## 🔧 故障排除

### **問題：執行指令時出錯**

**解決方案：**
```bash
# 1. 確認在 backend 目錄
pwd

# 2. 確認資料庫檔案存在
ls -la database.sqlite

# 3. 如果檔案不存在，執行初始化
npm run init-db

# 4. 重新嘗試
```

### **問題：資料沒有被清除**

**解決方案：**
```bash
# 1. 查看資料狀態
npm run db:info

# 2. 嘗試重建資料庫
npm run db:rebuild

# 3. 重新啟動後端服務
npm run dev
```

### **問題：重建後無法連接**

**解決方案：**
```bash
# 1. 停止後端服務
# 2. 重建資料庫
npm run db:rebuild

# 3. 初始化資料庫
npm run init-db

# 4. 重新啟動服務
npm run dev
```

---

## 📚 相關文檔

- [資料庫初始化](../init-database.ts)
- [User 模型](../src/models/User.ts)
- [Location 模型](../src/models/Location.ts)
- [測試指南](./MANUAL_TESTING_GUIDE.md)

---

## 🎉 快速參考

```bash
# 查看資訊
npm run db:info

# 清除資料（保留結構）
npm run db:clear

# 重建資料庫（刪除並重建）
npm run db:rebuild

# 初始化資料庫
npm run init-db

# 啟動服務
npm run dev
```

---

**記得在清除或重建資料庫後，需要重新建立測試帳號和資料！** 🚀

